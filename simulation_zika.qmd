---
title: "Modélisation de l'épidemie de Zika à San Andres en 2015"
date: "`r Sys.Date()`"
author: "Capucine Benoit-Grignard, Maite Decencière"
format:
  html:
    toc: true
    toc-floating: true
    number-sections: true
    code-fold: true
    embed-resources: true
    toc-depth: 4
    theme: cosmo
    highlight-style: pygments
    fig.align: center
---

# Packages
```{r, message = FALSE, warning = FALSE}
rm(list = ls())

# Installation des packages s'ils ne sont pas installés ------------------------
requiredPackages <- c("outbreaks", "lubridate", "dplyr", "data.table", "readr", 
                      "deSolve", "abc", "ggplot2", "grid", "gridExtra",
                      "ggpubr", "GGally", "devtools")
for(package in requiredPackages){ 
  if(!requireNamespace(package, quietly = TRUE))
    install.packages(package)
}
if(!requireNamespace("BRREWABC")){install_github("gaelbn/BRREWABC")}

## Packages dont sont issues les données ---------------------------------------
library(outbreaks)

## Packages pour la gestion des données ----------------------------------------
library(lubridate)  # Gestion des dates 
library(dplyr)      # Gestion des data.frame
library(data.table) # Gestion des data.frame
library(readr)      # Lecture fichier .txt / .csv

## Packages pour la simulation / l'inférence / l'ABC ---------------------------
library(deSolve)    # Resultion d'équations différentielles
library(abc)        # Méthode d'ABC rejection et cross validation
library(BRREWABC)

## Packages graphiques ---------------------------------------------------------
library(ggplot2)   # Graphiques 
library(grid)      # Rearrange les figures
library(gridExtra) # Rearrange les figures
library(ggpubr)    # Rearrange les figures
library(GGally)

library(devtools)
```

# Données
Données d'incidence journalière de l'épidémie de Zika, survenue sur l'ile de San Andres en 2015, issues du package `outbreaks`
```{r}
data <- zika_sanandres_2015
data$cumule <- cumsum(data$cases) # incidence cumulée
data$cases_ajuste <- data$cases
```

```{r}
plot(data, pch = 19)
plot(x = data$date, y = data$cumule)

ggplot(data, aes(x = date, y = cases))+
  geom_line() + 
  geom_point(alpha = 0.7) +
  theme_bw()
```

## Rajouter les pas de temps manquants (avec des NA)
Pour avoir la bonne taille de data.frame en terme de nombre de jours (par rapport à la simulation), il est nécessaire de rajouter les jours manquants. L'incidence pour ces jours sera `NA`. 
```{r}
tt_data <- seq(from = min(data$date), to = max(data$date), by = "day")
tt_data <- data.frame(date = tt_data) %>%
  left_join(., data, by = "date") %>%
  mutate(week = floor(as.numeric(date - min(date))/7))
```

## Données d'incidence hebdomadaire depuis le début de suivi
```{r}
data_sem <- tt_data %>%
  group_by(week) %>%
  summarize(cases = sum(cases, na.rm = TRUE)) %>% #incidence hebdomadaire
  mutate(cumule = cumsum(cases)) #incidence hebdomadaire cumulée
```

## Données météo 
Données de température et de pluviométrie horaire sur la zone d'étude entre septembre 2015 et février 2016, issues de la base de données ERA5 
```{r}
meteo <- read.csv("era5.csv")
data_sem_meteo <- meteo %>%
  mutate(valid_time = as.POSIXct(valid_time),
         day = as_date(valid_time), 
         week = floor(as.numeric(day - min(day))/7)) %>%
  group_by(week) %>%
  summarize(tp_mean = mean(tp, na.rm = TRUE), 
            sst_mean = mean(sst, na.rm = TRUE), 
            tp_min = min(tp, na.rm = TRUE), 
            sst_min = min(sst, na.rm = TRUE), 
            tp_max = max(tp, na.rm = TRUE), 
            sst_max = max(sst, na.rm = TRUE)) %>%
  left_join(., data_sem, by = "week")

data_sem_meteo %>% 
  ggplot(., aes(x = week, y = cases)) + 
  # geom_line(color = "black", lwd = 0.8) + 
  # geom_point(color = "black", alpha = 0.5, size = 2.5) +
  geom_line(aes(y = tp_mean), col = "red") +
  geom_ribbon(aes(ymin = tp_min, ymax = tp_max), fill = "red", alpha = 0.3) + 
  geom_hline(yintercept = 0, col = "black") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 15), legend.position = "none", 
        axis.text = element_text(size = 14)) +
  xlab("Durée de l'épidemie (en semaines)") + 
  ylab("Incidence hebdomadaire (nombre de nouveaux cas)")
```

```{r}
# data %>%
#   left_join(., era5, by = c("date" = "valid_time"))
```

# Modèle SEAIR
Modèle SEAIR avec cinq compartiments sur une seule population humaine
```{r}
SEIAR <- function(t, state, parameters) {

  with(as.list(c(state, parameters)), {

    # Forces d'infection integrant moustiques
    lambda_H <- beta * (I_H + theta * A_H) / N_H

    # Humains
    dS_H <- -lambda_H * S_H                         # Individus susceptibles                  
    dE_H <-  lambda_H * S_H - sigma_H * E_H         # Individus exposés 
    dI_H <-  p * sigma_H * E_H - gamma_I * I_H      # Individus infectés
    dA_H <- (1 - p) * sigma_H * E_H - gamma_A * A_H # Individus asymptomatiques
    dR_H <-  gamma_I * I_H + gamma_A * A_H          # Individus rétablis

    list(c(
      dS_H, dE_H, dI_H, dA_H, dR_H
    ))
  })
}
```

Paramètres du modèle : 
```{r}
parameters <- c(
  
  # Taille de population
  N_H = 54500,

  # Transmission 
  beta = 0.5, 

  # Humains
  sigma_H = 1/5.7, # taux d'incubation : 1/ durée incubation
  gamma_I = 1/4.7, # taux de guérison des symptomatqiues : 1/ duree infection
  gamma_A = 1/4.7, # taux de guérison des asymptomatqiues : 1/ duree infection

  p     = 0.2,   # proportion d'inidvidus symptomatiques dans la population
  theta = 0.7    # infectiosité relative des asymptomatiques
)

## Conditions initiales de la simulation  --------------------------------------

init <- c(
  S_H = as.numeric(parameters["N_H"]) - 1, # Toute la population est suscpetible (sauf le patient 0)
  E_H = 1,                                 # 1 seule personne exposée dans la population 
  I_H = 0,
  A_H = 0,
  R_H = 0
)

## Durée de la simulation ------------------------------------------------------
times_obs <- seq(0, 146, by = 1) # mettre + long 
times_sim <- seq(0, 500, by = 1) # mettre + long 
```

# Inférence du modèle avec des paramètres fixés 
```{r}
out <- ode(
  y = init,
  times = times,
  func = SEIAR,
  parms = parameters,
  method = "rk4"
)

out <- as.data.frame(out)
```

Incidence : 
```{r}
# Incidence : nbr nvlles infections par intervalle de tps 
# sigma x E (nbr indiv qui passent de E à I par jour)
# Incidence en nbr indiv/jours
out$incidence <- parameters["sigma_H"] * out$E_H

# Cas observés : nbr de cas détectés par jour 
taux_detec <- 1 #le faire varier : début infection (X%) vs fin infcetion (100%)
out$incidence_obs <- taux_detec * parameters["p"] * out$incidence
out$cumule <- cumsum(out$incidence_obs)

out <- cbind(out, tt_data)
```

```{r}
plot(out$time, out$incidence_obs,
     type = "l", lwd = 2,
     xlab = "Temps (jours)",
     ylab = "Incidence journalière")
lines(out$time+40, tt_data$cases)

plot(out$time, out$cumule,
     type = "l", lwd = 2,
     xlab = "Temps (jours)",
     ylab = "Incidence cumulée")
lines(out$time, tt_data$cumule)
```
Décalage des dates !!! On a pas le début de l'épidémie

```{r}
indic_week <- tapply(out$incidence_obs, floor(out$time/7), sum)

plot(data_sem$week, indic_week,
     type = "l", lwd = 2,
     xlab = "Temps (semaine depuis le début de l'étude)",
     ylab = "Incidence hebdomadaire")
lines(data_sem$week, data_sem$cases)
```

```{r}
outA <- ode(
  y = init,
  times = times,
  func = SEIAR_SEI,
  parms = parameters,
  method = "rk4"
)

outA <- as.data.frame(outA)
```

```{r}
outA$incidence <- parameters["sigma_H"] * outA$E_H
```

```{r}
plot(outA$time, outA$incidence*55000*0.2,
     type = "l", lwd = 2,
     xlab = "Temps (jours)",
     ylab = "Incidence journalière")

```

# Inférence des paramètres : ABC rejection
Critère à optimiser : Somme des carrés des écarts (incidence à la fin de l'épidémie + incidence cumulée)
La SSE pénalise fortement les écarts importants, ce qui la rend sensible aux valeurs aberrantes. Elle est adaptée lorsque les erreurs sont supposées suivre une distribution normale.   
Si distribution non normale : erreur absolue moyenne (MAE)    

Probleme : on simule à partir du 1er infecté / les data commencent au 1er cas détécté. Le modèle a du retard ! (entre : incubation, propagation, asympto...). Si on décale pas, incidence sur le pas de temps plate !

## 10 000 simulations 
```{r}
## Nombre de simulations -------------------------------------------------------
T = 10000

## Construction du dataframe des simulations -----------------------------------
df_param <- data.frame(
  ## Statistiques résumées : 
  # dist_cumul = rep(NA, T), 
  #SCE = rep(NA, T),
  MAE = rep(NA, T),
  ## Priors testés : 
  beta = runif(T, min = 0, max = 3), 
  theta = runif(T, min = 0, max = 1), 
  p = runif(T, min = 0.01, max = 0.8) 
)

for (i in 1:T){
  
  # Echantillonnage des paramètres ---------------------------------------------
  parameters <- c(
    N_H = 54500,               # taille de population
    beta = df_param[i,]$beta,
    # beta = 0.5, 
    sigma_H = 1/5.7,           # selon biblio
    gamma_I = 1/4.7,           # selon biblio
    gamma_A = 1/4.7,           # selon biblio
    p = df_param[i,]$p,
    # p = 0.2,
    # theta = 0.7)
    theta = df_param[i,]$theta)
  
  # Simulation des données -----------------------------------------------------
  out <- ode(
    y = init,
    times = times_sim, #sur le temps du modele : + long 
    func = SEIAR,
    parms = parameters,
    method = "rk4")
  
  # Calcul incidence -----------------------------------------------------------
  out <- as.data.frame(out)
  out$incidence <- parameters["sigma_H"] * out$E_H * parameters["p"] # durée incubation x nbr d'exposés x proba symptomatique 
  
  # Remettre les data au même niveau que le modèle : décalage temporel ---------
  # Prendre 1er temps où inicidence obs = 1 (1er cas)
  t_align <- which(out$incidence >= 1)[1] 
  
  # si t_align = NA : jamais inicidence de 1, on n'enregistre pas la simulation 
  if(!is.na(t_align)){
    out <- out[t_align:(t_align + nrow(tt_data) - 1), ] # prendre 147 jours après le 1er cas détecté par le modèle
    out <- cbind(out, tt_data) #jointure avec le tableau des données observées 
  
    out_week <- out %>%
      mutate(week = floor(as.numeric(date - min(date))/7)) %>% #création des semaines 
      group_by(week) %>%
      summarize(cases_obs = sum(cases, na.rm = TRUE),          #somme par semaine obs 
                cases_sim = sum(incidence, na.rm = TRUE)) %>%
      ungroup() %>%
      arrange(week) %>%
      mutate(cases_obs_cum = cumsum(cases_obs),                 # cumul pour chaque semaine 
            cases_sim_cum = cumsum(cases_sim))
  
  # Calcul de la distance ------------------------------------------------------
    # dist <- out_week %>% 
    #   summarise(SCE = sum((cases_obs_cum - cases_sim_cum)^2), # SSE sur l'incidence cumulée
    #             MAE = mean(abs(cases_obs - cases_sim))) # MAE sur l'incidence
      dist <- out_week %>% 
       summarise(MAE = mean(abs(cases_obs_cum - cases_sim_cum))) # MAE sur l'incidence cumulée
    df_param[i,]$MAE <- dist$MAE
  }
    # print(i)
}

## Ordination des simulations par valeurs de MAE -------------------------------
df_param = df_param[order(df_param$MAE, decreasing = FALSE),] 

## Conservation des 500 meilleures simulations ---------------------------------
df_subset <- df_param[c(1:500),c("beta","theta", "p")]
```

```{r}
# write.table(df_param, "simul_beta_theta.csv", sep="t",dec=",", na=" ")
# write.table(df_param, "simul_p_theta.csv", sep="t",dec=",", na=" ")
# write.table(df_param, "simul_p_beta.csv", sep="t",dec=",", na=" ")
# write.table(df_param, "simul_p_beta_theta_sure.csv", sep="t",dec=",", na=" ")
# df_param <- read.table("simul_beta_theta.csv", sep="t",dec=",", na=" ")
# df_param <- read.table("simul_p_beta.csv", sep="t",dec=",", na=" ")
# df_param <- read.table("simul_p_beta_theta.csv", sep="t",dec=",", na=" ")
# df_param <- read.table("simul_p_theta.csv", sep="t",dec=",", na=" ")

df_param = df_param[order(df_param$MAE, decreasing = FALSE),] 

# df_subset <- df_param[c(1:500),c("beta","theta", "p")]
# df_subset <- df_param[c(1:500),c("beta","theta")]
df_subset <- df_param[c(1:500),c("p", "theta", "beta")]
```

```{r}
ggpairs(df_subset, upper = list(continuous = wrap('cor', size = 14))) +
  theme_bw(base_size = 20) 
```

## Simulation du modèle avec la meilleure distance MAE
```{r}
i = 1

parameter_closest <- c(
  N_H = 54500,
  # beta = df_subset[i,]$beta,
  beta = 0.5,
  sigma_H = 1/5.7,
  gamma_I = 1/4.7,
  gamma_A = 1/4.7,
  # p = 0.2,
  p = df_subset[i,]$p,
  theta = df_subset[i,]$theta)
  # theta = 0.7)

out_close <- ode(
  y = init,
  times = times_sim,
  func = SEIAR,
  parms = parameter_closest,
  method = "rk4")

out_close <- as.data.frame(out_close)
out_close$incidence <- parameter_closest["sigma_H"] * out_close$E_H * parameter_closest["p"]
```

Remettre au bon pas temporel et affichage :
```{r}
t_align <- which(out_close$incidence >= 1)[1]
out_close_tempo <- out_close[t_align:(t_align + nrow(tt_data) - 1), ] # prendre 147 jours après le 1er cas détecté par le modèle

## Lier avec le dataframe des données observées --------------------------------
df_out <- cbind(out_close_tempo, tt_data) %>%
  group_by(week) %>% # somme par semaine
  summarize(cases_obs = sum(cases, na.rm = TRUE), 
            cases_sim = sum(incidence, na.rm = TRUE)) %>%
  mutate(cumule_obs = cumsum(cases_obs), 
         cumule_sim = cumsum(cases_sim))
  
## Comparaison visuelle avec les incidences observées --------------------------
plot(df_out$week, df_out$cumule_obs,  col = "blue")
lines(df_out$cumule_sim, col = "red")

plot(df_out$week, df_out$cases_obs,  col = "blue")
lines(df_out$cases_sim, col = "red")

plot(df_out$cases_sim)
plot(df_out$cumule_sim)
```

```{r}
### Garder tt les plots dans 1 même graph 
# df_out_p_beta_theta <- df_out
# df_out_p_beta <- df_out
df_out_p_theta <- df_out
# df_out_beta_theta <- df_out
```

Bon ça marche pas top, peut être que l'exploration de l'espace des paramètres est pas top ? ou la distance choisie.ou les summary stat


## Cross validation des paramètres
```{r}
setDT(df_param)

cv_zika <- cv4abc(param = df_param[, .(theta, beta, p)],
                  sumstat = df_param[, MAE], nval = 500,
                  tols = c(0.05), method = "rejection")

# cv_zika <- cv4abc(param = df_param[,.(beta,theta)], sumstat = df_param[,MAE], nval = 500, tols =c(0.05), method = "rejection")

plot(cv_zika)

summary(cv_zika)
```
Très mauvais pour beta et theta

## ABC rejection
```{r}
Tol = 0.1
setDT(df_param)

test_abc_n <- abc(target = c(0), 
                  param = df_param[,.(beta,p)],
                  # param = df_param[,.(beta,theta,p)],
                  # param = df_param[,.(beta,theta)], 
                  # sumstat = df_param[,.(dist_cumul, MAE)], 
                  sumstat = df_param[,MAE], 
                  tol = Tol , method = "rejection")

summary(test_abc_n)
hist(test_abc_n)
plot(test_abc_n, param = df_param[,.(beta,theta,p)])
```
Donne quelque chose mais on peut pas faire confiance si nos paramètres sont pas identifiables

## Plot 
```{r}
a <- data_sem %>% 
  ggplot(., aes(x = week, y = cases)) + 
  geom_line(color = "black", lwd = 0.8) + 
  geom_point(color = "black", alpha = 0.5, size = 2.5) +
  geom_hline(yintercept = 0, col = "black") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 15), legend.position = "none", 
        axis.text = element_text(size = 14)) +
  xlab("Durée de l'épidemie (en semaines)") + 
  ylab("Incidence hebdomadaire (nombre de nouveaux cas)")

b <- data_sem %>% 
  ggplot(., aes(x = week, y = cumule)) + 
  geom_line(color = "black", lwd = 0.8) + 
  geom_point(color = "black", alpha = 0.5, size = 2.5) +
  geom_hline(yintercept = 0, col = "black") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 15), legend.position = "none", 
        axis.text = element_text(size = 14)) +
  xlab("Durée de l'épidemie (en semaines)") + 
  ylab("Incidence hebdomadaire cumulée (nombre de nouveaux cas)")

ggarrange(a, b)
```

```{r}
tout <- rbind(df_out_p_beta_theta %>% mutate(simu = "p_beta_theta"), 
              df_out_p_beta %>% mutate(simu = "p_beta"),
              df_out_p_theta %>% mutate(simu = "p_theta"), #) #, 
              df_out_beta_theta %>% mutate(simu = "beta_theta"))
# write.csv(tout, "tout.csv")

a <- tout %>% 
  group_by(simu) %>%
  ggplot(aes(x = week, y = cases_sim, col = simu), alpha = 0.5) +
  geom_line(lwd = 1) + 
  geom_line(aes(y = tout$cases_obs), color = "black", lwd = 0.8) + 
  geom_point(aes(y = tout$cases_obs), color = "black", alpha = 0.5, size = 2.5) +
  geom_hline(yintercept = 0, col = "black") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 15), 
        legend.position = "none", 
        axis.text = element_text(size = 14)) +
  xlab("Durée de l'épidemie (en semaines)") + 
  ylab("Incidence hebdomadaire (nombre de nouveaux cas)") +
  labs(color = "Incidence simulée") + 
  ylim(c(0, 200))

b <- tout %>% 
  group_by(simu) %>%
  ggplot(., aes(x = week, y = cumule_sim, col = simu)) +
  geom_line(lwd = 1) + 
  # geom_line(aes(y = df_out_beta_theta$cumule_sim), lty = 3) +
  geom_line(aes(y = tout$cumule_obs), color = "black", lwd = 0.8) + 
  geom_point(aes(y = tout$cumule_obs), color = "black", alpha = 0.5, size = 2.5) + 
  geom_hline(yintercept = 0, col = "black") + 
  theme_bw() + 
  theme(axis.title = element_text(size = 15), 
        legend.text = element_text(size = 15), 
        legend.title = element_text(size = 16), 
        axis.text = element_text(size = 14)) + 
  xlab("Durée de l'épidemie (en semaines)") + 
  ylab("Incidence hebdomadaire cumulée (nombre de nouveaux cas)") +
  labs(color = "Incidence simulée") +
  ylim(c(0, 1500))

ggarrange(a, b)
```

